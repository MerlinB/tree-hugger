/** 
 * Tree Hugger - meta-tree-hugger [v0.0.2]
 * A Metanet tree traversal tool.
 * https://treehugger.bitpaste.app
 * Copyright Â© 2019 libitx
 */
!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).TreeHugger=r()}(this,function(){"use strict";function t(t,r){return t(r={exports:{}},r.exports),r.exports}var f=t(function(t){var r=function(o){var s,t=Object.prototype,c=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",e=r.asyncIterator||"@@asyncIterator",n=r.toStringTag||"@@toStringTag";function a(t,r,e,n){var i=r&&r.prototype instanceof u?r:u,o=Object.create(i.prototype),a=new _(n||[]);return o._invoke=function(o,a,u){var s=h;return function(t,r){if(s===l)throw new Error("Generator is already running");if(s===d){if("throw"===t)throw r;return S()}for(u.method=t,u.arg=r;;){var e=u.delegate;if(e){var n=j(e,u);if(n){if(n===y)continue;return n}}if("next"===u.method)u.sent=u._sent=u.arg;else if("throw"===u.method){if(s===h)throw s=d,u.arg;u.dispatchException(u.arg)}else"return"===u.method&&u.abrupt("return",u.arg);s=l;var i=f(o,a,u);if("normal"===i.type){if(s=u.done?d:p,i.arg===y)continue;return{value:i.arg,done:u.done}}"throw"===i.type&&(s=d,u.method="throw",u.arg=i.arg)}}}(t,e,a),o}function f(t,r,e){try{return{type:"normal",arg:t.call(r,e)}}catch(t){return{type:"throw",arg:t}}}o.wrap=a;var h="suspendedStart",p="suspendedYield",l="executing",d="completed",y={};function u(){}function v(){}function g(){}var b={};b[i]=function(){return this};var w=Object.getPrototypeOf,m=w&&w(w(A([])));m&&m!==t&&c.call(m,i)&&(b=m);var x=g.prototype=u.prototype=Object.create(b);function k(t){["next","throw","return"].forEach(function(r){t[r]=function(t){return this._invoke(r,t)}})}function L(s){var r;this._invoke=function(e,n){function t(){return new Promise(function(t,r){!function r(t,e,n,i){var o=f(s[t],s,e);if("throw"!==o.type){var a=o.arg,u=a.value;return u&&"object"==typeof u&&c.call(u,"__await")?Promise.resolve(u.__await).then(function(t){r("next",t,n,i)},function(t){r("throw",t,n,i)}):Promise.resolve(u).then(function(t){a.value=t,n(a)},function(t){return r("throw",t,n,i)})}i(o.arg)}(e,n,t,r)})}return r=r?r.then(t,t):t()}}function j(t,r){var e=t.iterator[r.method];if(e===s){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=s,j(t,r),"throw"===r.method))return y;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var n=f(e,t.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,y;var i=n.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=s),r.delegate=null,y):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function O(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function E(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function _(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function A(r){if(r){var t=r[i];if(t)return t.call(r);if("function"==typeof r.next)return r;if(!isNaN(r.length)){var e=-1,n=function t(){for(;++e<r.length;)if(c.call(r,e))return t.value=r[e],t.done=!1,t;return t.value=s,t.done=!0,t};return n.next=n}}return{next:S}}function S(){return{value:s,done:!0}}return v.prototype=x.constructor=g,g.constructor=v,g[n]=v.displayName="GeneratorFunction",o.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===v||"GeneratorFunction"===(r.displayName||r.name))},o.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,g):(t.__proto__=g,n in t||(t[n]="GeneratorFunction")),t.prototype=Object.create(x),t},o.awrap=function(t){return{__await:t}},k(L.prototype),L.prototype[e]=function(){return this},o.AsyncIterator=L,o.async=function(t,r,e,n){var i=new L(a(t,r,e,n));return o.isGeneratorFunction(r)?i:i.next().then(function(t){return t.done?t.value:i.next()})},k(x),x[n]="Generator",x[i]=function(){return this},x.toString=function(){return"[object Generator]"},o.keys=function(e){var n=[];for(var t in e)n.push(t);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},o.values=A,_.prototype={constructor:_,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=s,this.done=!1,this.delegate=null,this.method="next",this.arg=s,this.tryEntries.forEach(E),!t)for(var r in this)"t"===r.charAt(0)&&c.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=s)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function t(t,r){return o.type="throw",o.arg=e,n.next=t,r&&(n.method="next",n.arg=s),!!r}for(var r=this.tryEntries.length-1;0<=r;--r){var i=this.tryEntries[r],o=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var a=c.call(i,"catchLoc"),u=c.call(i,"finallyLoc");if(a&&u){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(t,r){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.tryLoc<=this.prev&&c.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=r&&r<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=r,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(o)},complete:function(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),y},finish:function(t){for(var r=this.tryEntries.length-1;0<=r;--r){var e=this.tryEntries[r];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),E(e),y}},catch:function(t){for(var r=this.tryEntries.length-1;0<=r;--r){var e=this.tryEntries[r];if(e.tryLoc===t){var n=e.completion;if("throw"===n.type){var i=n.arg;E(e)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,r,e){return this.delegate={iterator:A(t),resultName:r,nextLoc:e},"next"===this.method&&(this.arg=s),y}},o}(t.exports);try{regeneratorRuntime=r}catch(t){Function("r","regeneratorRuntime = r")(r)}});function s(t,r,e,n,i,o,a){try{var u=t[o](a),s=u.value}catch(t){return void e(t)}u.done?r(s):Promise.resolve(s).then(n,i)}var h=function(u){return function(){var t=this,a=arguments;return new Promise(function(r,e){var n=u.apply(t,a);function i(t){s(n,r,e,i,o,"next",t)}function o(t){s(n,r,e,i,o,"throw",t)}i(void 0)})}};var i=function(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t};var e,n,r,c=function(r){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{},n=Object.keys(e);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.forEach(function(t){i(r,t,e[t])})}return r},p=t(function(t,r){var e=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==e)return e;throw new Error("unable to locate global object")}();t.exports=r=e.fetch,r.default=e.fetch.bind(e),r.Headers=e.Headers,r.Request=e.Request,r.Response=e.Response}),l=(p.Headers,p.Request,p.Response,{baseUrl:"https://metanaria.planaria.network/q/",headers:{},mapObject:function(t){return t},find:(r=h(f.mark(function t(r){var e,n,i,o,a,u=this,s=arguments;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=1<s.length&&void 0!==s[1]?s[1]:{},n=this._buildQuery(r,e),i=this._encodeQuery(n),o=this.baseUrl+i,a=c({},this.headers,e.headers),e.debug&&(console.log(n),console.log(o)),t.abrupt("return",p(o,{headers:a}).then(function(t){return t.json()}).then(function(t){return t.metanet.map(u.mapObject)}));case 4:case"end":return t.stop()}},t,this)})),function(t){return r.apply(this,arguments)}),findSingle:(n=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=c({sort:{"blk.i":-1,i:-1},limit:1},r),t.abrupt("return",this.find(n,e).then(function(t){return t[0]||null}));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return n.apply(this,arguments)}),findAll:(e=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=c({sort:{"blk.i":1,i:1}},r),t.abrupt("return",this.find(n,e));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return e.apply(this,arguments)}),_buildQuery:function(t,r){var e=1<arguments.length&&void 0!==r?r:{},n={v:3,q:t},i=Object.keys(e).filter(function(t){return["aggregate","project","sort","limit","skip"].includes(t)}).reduce(function(t,r){return t[r]=e[r],t},{});return Object.assign(n.q,i),e.find&&Object.assign(n.q.find,e.find),n.q.project&&Object.assign(n.q.project,{node:1,parent:1,ancestor:1,child:1}),n},_encodeQuery:function(t){var r=JSON.stringify(t);return"function"==typeof btoa?btoa(r):Buffer.from(r).toString("base64")}});var d=function(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")};function o(t,r){for(var e=0;e<r.length;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var a,u,y,v,g,b,w,m=function(t,r,e){return r&&o(t.prototype,r),e&&o(t,e),t},x=function(){function MetaNode(t){d(this,MetaNode),this.tx=t}var r,e,n,i,o,a,u,s,c;return m(MetaNode,[{key:"root",value:(c=h(f.mark(function t(r){var e;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isRoot)return t.abrupt("return",this);t.next=2;break;case 2:return e={"node.id":this.tx.ancestor[0].id},t.abrupt("return",l.findSingle({find:e},r));case 4:case"end":return t.stop()}},t,this)})),function(t){return c.apply(this,arguments)})},{key:"parent",value:(s=h(f.mark(function t(r){var e;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isRoot)return t.abrupt("return",null);t.next=2;break;case 2:return e={"node.id":this.tx.parent.id},t.abrupt("return",l.findSingle({find:e},r));case 4:case"end":return t.stop()}},t,this)})),function(t){return s.apply(this,arguments)})},{key:"ancestors",value:(u=h(f.mark(function t(r){var e,n,i=this;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isRoot)return t.abrupt("return",[]);t.next=2;break;case 2:return e=this.tx.ancestor.map(function(t){return t.id}).filter(function(t){return t!==i.id}),n={find:{"node.id":{$in:e}},sort:{"blk.i":-1,i:-1}},t.abrupt("return",l.findAll(n,r));case 5:case"end":return t.stop()}},t,this)})),function(t){return u.apply(this,arguments)})},{key:"siblings",value:(a=h(f.mark(function t(r){var e;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isRoot)return t.abrupt("return",[]);t.next=2;break;case 2:return e={$and:[{"parent.id":this.tx.parent.id},{"node.id":{$ne:this.id}}]},t.abrupt("return",l.findAll({find:e},r));case 4:case"end":return t.stop()}},t,this)})),function(t){return a.apply(this,arguments)})},{key:"children",value:(o=h(f.mark(function t(r){var e;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isLeaf)return t.abrupt("return",[]);t.next=2;break;case 2:return e={"parent.id":this.id},t.abrupt("return",l.findAll({find:e},r));case 4:case"end":return t.stop()}},t,this)})),function(t){return o.apply(this,arguments)})},{key:"descendants",value:(i=h(f.mark(function t(r){var e;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isLeaf)return t.abrupt("return",[]);t.next=2;break;case 2:return e={$and:[{"ancestor.id":this.id},{"node.id":{$ne:this.id}}]},t.abrupt("return",l.findAll({find:e},r));case 4:case"end":return t.stop()}},t,this)})),function(t){return i.apply(this,arguments)})},{key:"selfAndAncestors",value:(n=h(f.mark(function t(r){var e=this;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.ancestors(r).then(function(t){return[e].concat(t)}));case 1:case"end":return t.stop()}},t,this)})),function(t){return n.apply(this,arguments)})},{key:"selfAndSiblings",value:(e=h(f.mark(function t(r){var e=this;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.siblings(r).then(function(t){var r=t.findIndex(function(t){return t.tx.blk.i>=e.tx.blk.i&&t.tx.i>e.tx.i});return t.splice(r,0,e),t}));case 1:case"end":return t.stop()}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"selfAndDescendants",value:(r=h(f.mark(function t(r){var e=this;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.descendants(r).then(function(t){return[e].concat(t)}));case 1:case"end":return t.stop()}},t,this)})),function(t){return r.apply(this,arguments)})},{key:"id",get:function(){return this.tx.node.id}},{key:"txid",get:function(){return this.tx.node.tx}},{key:"address",get:function(){return this.tx.node.a}},{key:"isRoot",get:function(){return!this.tx.parent}},{key:"isChild",get:function(){return!this.isRoot}},{key:"isLeaf",get:function(){return!this.tx.child||!this.tx.child.length}},{key:"inputs",get:function(){return this.tx.in||[]}},{key:"outputs",get:function(){return this.tx.out||[]}},{key:"opReturn",get:function(){return this.outputs.find(function(t){return 106===t.b0.op})||null}}]),MetaNode}();return l.mapObject=function(t){return new x(t)},{db:l,findSingleNode:(w=h(f.mark(function t(r,e){return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.db.findSingle(r,e));case 1:case"end":return t.stop()}},t,this)})),function(t,r){return w.apply(this,arguments)}),findAllNodes:(b=h(f.mark(function t(r,e){return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.db.findAll(r,e));case 1:case"end":return t.stop()}},t,this)})),function(t,r){return b.apply(this,arguments)}),findNodeById:(g=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={"node.id":r},t.abrupt("return",this.db.findSingle({find:n},e));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return g.apply(this,arguments)}),findNodeByTxid:(v=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={"node.tx":r},t.abrupt("return",this.db.findSingle({find:n},e));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return v.apply(this,arguments)}),findNodesByAddress:(y=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={"node.a":r},t.abrupt("return",this.db.findAll({find:n},e));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return y.apply(this,arguments)}),findNodesByParentId:(u=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={"parent.id":r},t.abrupt("return",this.db.findAll({find:n},e));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return u.apply(this,arguments)}),findNodeAndDescendants:(a=h(f.mark(function t(r,e){var n;return f.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={$or:[{"node.id":r},{"ancestor.id":r}]},t.abrupt("return",this.db.findAll({find:n},e));case 2:case"end":return t.stop()}},t,this)})),function(t,r){return a.apply(this,arguments)})}});
